#!/usr/bin/expect -f

set timeout 10

# Start the bestool-psql program
spawn cargo run --package bestool-psql -- -- -d tamanu_meta

# Wait for initial prompt
expect {
    timeout { puts "ERROR: Timeout waiting for initial prompt"; exit 1 }
    "tamanu_meta=# " { puts "\n=== Got initial prompt ===" }
}

# Send a simple query
puts "\n=== Sending: SELECT 1; ==="
send "SELECT 1;\r"

# Wait for the result
expect {
    timeout { puts "ERROR: Timeout waiting for SELECT 1 result"; exit 1 }
    "tamanu_meta=# " { puts "=== Got prompt after SELECT 1 ===" }
}

# Send another query
puts "\n=== Sending: SELECT 'hello'; ==="
send "SELECT 'hello';\r"

# Wait for the result
expect {
    timeout { puts "ERROR: Timeout waiting for SELECT 'hello' result"; exit 1 }
    "tamanu_meta=# " { puts "=== Got prompt after SELECT 'hello' ===" }
}

# Exit
puts "\n=== Sending: \\q ==="
send "\\q\r"

expect eof
